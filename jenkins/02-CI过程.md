# CI过程


## 目标
- 创建一个`jenkins`任务进行编译打包，将`docker`镜像上传至本地镜像仓库。


## 过程
- 创建`jenkins`任务——`alertmanager-qywx-bot`。
  ```xml
  <?xml version='1.1' encoding='UTF-8'?>
  <project>
    <actions/>
    <description></description>
    <keepDependencies>false</keepDependencies>
    <properties/>
    <scm class="hudson.plugins.git.GitSCM" plugin="git@5.7.0">
      <configVersion>2</configVersion>
      <userRemoteConfigs>
        <hudson.plugins.git.UserRemoteConfig>
          <url>https://github.com/whh881114/go-projects.git</url>
        </hudson.plugins.git.UserRemoteConfig>
      </userRemoteConfigs>
      <branches>
        <hudson.plugins.git.BranchSpec>
          <name>*/master</name>
        </hudson.plugins.git.BranchSpec>
      </branches>
      <doGenerateSubmoduleConfigurations>false</doGenerateSubmoduleConfigurations>
      <submoduleCfg class="empty-list"/>
      <extensions/>
    </scm>
    <!-- 这里指定go编译环境 -->
    <assignedNode>go</assignedNode>
    <canRoam>false</canRoam>
    <disabled>false</disabled>
    <blockBuildWhenDownstreamBuilding>false</blockBuildWhenDownstreamBuilding>
    <blockBuildWhenUpstreamBuilding>false</blockBuildWhenUpstreamBuilding>
    <triggers/>
    <concurrentBuild>false</concurrentBuild>
    <builders>
      <hudson.tasks.Shell>
        <command>cd $JOB_NAME
  go build -o ${JOB_NAME} main.go</command>
        <configuredLocalRules/>
      </hudson.tasks.Shell>
    </builders>
    <publishers>
      <hudson.plugins.parameterizedtrigger.BuildTrigger plugin="parameterized-trigger@859.vb_e3907a_07a_16">
        <configs>
          <hudson.plugins.parameterizedtrigger.BuildTriggerConfig>
            <configs>
              <!-- 定义环境变量，传递给下一个job使用 -->
              <hudson.plugins.parameterizedtrigger.PredefinedBuildParameters>
                <properties>UPSTREAM_JOB_NAME=${JOB_NAME}
  UPSTREAM_APP_NAME=${JOB_NAME}
  UPSTREAM_GIT_COMMIT=${GIT_COMMIT}
  UPSTREAM_WORKSPACE=${WORKSPACE}/${JOB_NAME}
  UPSTREAM_DOCKERFILE=jenkins.Dockerfile</properties>
                <textParamValueOnNewLine>false</textParamValueOnNewLine>
              </hudson.plugins.parameterizedtrigger.PredefinedBuildParameters>
            </configs>
            <!-- 当前job构建完成后，触发下个job: idc-registry -->
            <projects>idc-registry</projects>
            <condition>SUCCESS</condition>
            <triggerWithNoParameters>false</triggerWithNoParameters>
            <triggerFromChildProjects>false</triggerFromChildProjects>
          </hudson.plugins.parameterizedtrigger.BuildTriggerConfig>
        </configs>
      </hudson.plugins.parameterizedtrigger.BuildTrigger>
    </publishers>
    <buildWrappers/>
  </project>
  ```

- `alertmanager-qywx-bot`构建日志。
  ```
  Started by user admin
  Running as SYSTEM
  Agent go-67n35 is provisioned from template go
  ---
  apiVersion: "v1"
  kind: "Pod"
  metadata:
    annotations:
      kubernetes.jenkins.io/last-refresh: "1747814837732"
    labels:
      jenkins/jenkins-jenkins-agent: "true"
      jenkins/label-digest: "da76f5daeb9956850c65d3c7618a5cea2b54906b"
      jenkins/label: "jenkins-jenkins-agent_go"
      kubernetes.jenkins.io/controller: "http___jenkins_jenkins_svc_cluster_local_8080x"
    name: "go-67n35"
    namespace: "jenkins"
  spec:
    containers:
    - args:
      - "********"
      - "go-67n35"
      env:
      - name: "JENKINS_SECRET"
        value: "********"
      - name: "JENKINS_TUNNEL"
        value: "jenkins-agent.jenkins.svc.cluster.local:50000"
      - name: "JENKINS_AGENT_NAME"
        value: "go-67n35"
      - name: "HTTPS_PROXY"
        value: "http://10.255.2.162:8001"
      - name: "REMOTING_OPTS"
        value: "-noReconnectAfter 1d"
      - name: "JENKINS_NAME"
        value: "go-67n35"
      - name: "JENKINS_AGENT_WORKDIR"
        value: "/home/jenkins/agent"
      - name: "HTTP_PROXY"
        value: "http://10.255.2.162:8001"
      - name: "JENKINS_URL"
        value: "http://jenkins.jenkins.svc.cluster.local:8080/"
      image: "harbor.idc.roywong.work/library/jenkins/inbound-agent-go:1.24.2"
      imagePullPolicy: "Always"
      name: "jnlp"
      resources:
        limits:
          memory: "8Gi"
          cpu: "4"
        requests:
          memory: "128Mi"
          cpu: "100m"
      tty: false
      volumeMounts:
      - mountPath: "/home/jenkins/agent"
        name: "workspace-volume"
        readOnly: false
      workingDir: "/home/jenkins/agent"
    imagePullSecrets:
    - name: "registry-idc-library"
    nodeSelector:
      kubernetes.io/os: "linux"
    restartPolicy: "Never"
    serviceAccountName: "jenkins-agent"
    volumes:
    - name: "workspace-volume"
      persistentVolumeClaim:
        claimName: "data-jenkins-workspace"
        readOnly: false
  
  Building remotely on go-67n35 (jenkins-jenkins-agent go) in workspace /home/jenkins/agent/workspace/alertmanager-qywx-bot
  The recommended git tool is: NONE
  No credentials specified
   > git rev-parse --resolve-git-dir /home/jenkins/agent/workspace/alertmanager-qywx-bot/.git # timeout=10
  Fetching changes from the remote Git repository
   > git config remote.origin.url https://github.com/whh881114/go-projects.git # timeout=10
  Fetching upstream changes from https://github.com/whh881114/go-projects.git
   > git --version # timeout=10
   > git --version # 'git version 2.39.5'
   > git fetch --tags --force --progress -- https://github.com/whh881114/go-projects.git +refs/heads/*:refs/remotes/origin/* # timeout=10
   > git rev-parse refs/remotes/origin/master^{commit} # timeout=10
  Checking out Revision fc6975f7dd1a6e51d23b67dd29e279075f4f3137 (refs/remotes/origin/master)
   > git config core.sparsecheckout # timeout=10
   > git checkout -f fc6975f7dd1a6e51d23b67dd29e279075f4f3137 # timeout=10
  Commit message: "增加docker-image-tag"
   > git rev-list --no-walk f0741ac24fe2e822f424e45cd2f40fc5e1ab0f9f # timeout=10
  [alertmanager-qywx-bot] $ /bin/sh -xe /tmp/jenkins395443670253171966.sh
  + cd alertmanager-qywx-bot
  + go build -o alertmanager-qywx-bot main.go
  Triggering a new build of idc-registry
  Finished: SUCCESS
  ```